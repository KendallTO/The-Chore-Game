<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>The Chore Game - Shop</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="site-header">
  
    <div class="container">
        <a href="index.html">
          <img class="logo" src="images/logo_chore_2.png" alt="Logo">
        </a>
        <div class="container-logo">
          <a href="index.html">
            <img class src="images/Logo_THE_GREAT_CHORE_OFF_Text.png" href = "index.html" alt="The Chore Game">
          </a>
        </div>
          <nav class="main-nav">
              <a class="header-btn" href="index.html">House</a>
              <a class ="header-btn" href="shop.html">Shop</a>
          </nav>
      </div>
</header>

    <main class="site-main container">
        <!-- points display with shop management in center -->
        <div class="points-display grid-3">
            <div class="points-box" id="left-points-box">
                <h3 id="left-header">Left Column</h3>
                <div class="points-value"><strong id="shop-left-points">0</strong> pts</div>
            </div>
            
            <!-- Shop management section (moved to center) -->
            <section class="shop-management">
                <div class="shop-header">
                    <h2>Shop Management</h2>
                    <button type="button" id="toggle-add-form" class="btn btn-add" aria-expanded="false" aria-controls="add-item-form">
                        <span class="btn-text">Add Item</span>
                        <span class="btn-icon">+</span>
                    </button>
                </div>

                <!-- collapsible add-item form -->
                <form id="add-item-form" class="shop-form hidden" aria-label="Add shop item" novalidate>
                    <h3 class="shop-form-title">Add New Item</h3>
                    <div class="form-row">
                        <input id="item-name" name="name" type="text" required aria-required="true" aria-label="Name" placeholder="Name*" />
                    </div>

                    <div class="form-row">
                        <textarea id="item-desc" name="description" rows="2" aria-label="Description (optional)" placeholder="Description (optional)"></textarea>
                    </div>

                    <div class="form-row">
                        <input id="item-price" name="price" type="number" min="0" step="5" required aria-required="true" aria-label="Price (points)" placeholder="Price (points)*" />
                    </div>

                    <div class="form-row">
                        <label for="item-one-time">One-time purchase</label>
                        <input id="item-one-time" name="oneTime" type="checkbox" aria-label="Mark as one-time purchase" />
                    </div>

                    <div class="form-row">
                        <button type="submit">Add Item</button>
                        <span id="form-msg" class="form-msg" role="status" aria-live="polite"></span>
                    </div>
                </form>
            </section>
            
            <div class="points-box" id="right-points-box">
                <h3 id="right-header">Right Column</h3>
                <div class="points-value"><strong id="shop-right-points">0</strong> pts</div>
            </div>
        </div>

        <!-- Available items section -->
        <section class="shop-items">
            <h2>Available Items</h2>
            <div id="products" class="grid-3" aria-live="polite">
                <!-- items rendered here -->
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>© <span id="year2"></span> The Great Chore-Off</p>
            <p> <span id = "year"></span> Made By: Sean Heiner, Spiter-Man, & Kendall Olson!
            </p>
        </div>
    </footer>

    <script>
        // minimal shop logic: store items in localStorage, render them, allow adding + purchase/delete
        (function(){
            const STORAGE_KEY = 'tcg_shop_items_v1';
            const defaultItems = [
                { id: Date.now()+1, name: 'Product 1', description: 'Sample item', price: 50, oneTime: false },
                { id: Date.now()+2, name: 'Product 2', description: '', price: 30, oneTime: true },
                { id: Date.now()+3, name: 'Product 3', description: '', price: 20, oneTime: false }
            ];

            const form = document.getElementById('add-item-form');
            const nameInput = document.getElementById('item-name');
            const descInput = document.getElementById('item-desc');
            const priceInput = document.getElementById('item-price');
            const oneTimeInput = document.getElementById('item-one-time');
            const productsEl = document.getElementById('products');
            const msgEl = document.getElementById('form-msg');

            // helper: round to nearest 5 (clamped to >= 0)
            function roundToNearest5(n){
                if(!Number.isFinite(n)) return 0;
                const r = Math.round(n / 5) * 5;
                return Math.max(0, r);
            }

            // when user finishes editing price, snap to nearest 5
            if(priceInput){
                priceInput.addEventListener('blur', () => {
                    const val = Number(priceInput.value);
                    if(Number.isNaN(val)) return;
                    priceInput.value = String(roundToNearest5(val));
                });
            }

            function loadItems(){
                try{
                    const raw = localStorage.getItem(STORAGE_KEY);
                    return raw ? JSON.parse(raw) : defaultItems.slice();
                }catch(e){
                    return defaultItems.slice();
                }
            }

            function saveItems(items){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
            }

            function createCard(item){
                const art = document.createElement('article');
                art.className = 'card product';
                art.dataset.id = String(item.id);

                const titleWrap = document.createElement('div');
                titleWrap.className = 'product-title-wrap';

                const title = document.createElement('h3');
                title.className = 'product-title';
                title.textContent = item.name;
                titleWrap.appendChild(title);

                if(item.oneTime){
                    const badge = document.createElement('span');
                    badge.className = 'badge one-time';
                    badge.textContent = 'One‑time';
                    titleWrap.appendChild(badge);
                }

                art.appendChild(titleWrap);

                if(item.description){
                    const p = document.createElement('p');
                    p.className = 'product-desc';
                    p.textContent = item.description;
                    art.appendChild(p);
                }

                const price = document.createElement('p');
                price.className = 'product-price';
                price.textContent = item.price + ' pts';
                art.appendChild(price);

                // actions: purchase + delete
                const actions = document.createElement('div');
                actions.className = 'product-actions';

                const buyBtn = document.createElement('button');
                buyBtn.type = 'button';
                buyBtn.className = 'btn btn-purchase';
                buyBtn.dataset.action = 'purchase';
                buyBtn.textContent = 'Purchase';
                actions.appendChild(buyBtn);

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'btn btn-delete';
                delBtn.dataset.action = 'delete';
                delBtn.textContent = 'Delete';
                actions.appendChild(delBtn);

                art.appendChild(actions);

                return art;
            }

            function render(){
                const items = loadItems();
                productsEl.innerHTML = '';
                items.forEach(it => productsEl.appendChild(createCard(it)));
            }

            form.addEventListener('submit', function(e){
                e.preventDefault();
                msgEl.textContent = '';

                const name = nameInput.value.trim();
                const desc = descInput.value.trim();
                const price = Number(priceInput.value);
                const oneTime = !!oneTimeInput.checked;

                if(!name){
                    msgEl.textContent = 'Name is required.';
                    nameInput.focus();
                    return;
                }
                if(Number.isNaN(price) || price < 0){
                    msgEl.textContent = 'Enter a valid price (0 or more).';
                    priceInput.focus();
                    return;
                }

                const items = loadItems();
                // round price to nearest multiple of 5 before saving
                const roundedPrice = roundToNearest5(price);
                const newItem = { id: Date.now(), name, description: desc, price: roundedPrice, oneTime };
                items.push(newItem);
                saveItems(items);
                render();

                form.reset();
                msgEl.textContent = 'Item added.';
                setTimeout(()=> msgEl.textContent = '', 2000);
            });

            // delegated click handler for purchase / delete
            productsEl.addEventListener('click', function(e){
                const btn = e.target.closest('button[data-action]');
                if(!btn) return;
                const action = btn.dataset.action;
                const card = btn.closest('.product');
                if(!card) return;
                const id = Number(card.dataset.id);
                if(action === 'purchase'){
                    purchaseItem(id);
                } else if(action === 'delete'){
                    deleteItem(id);
                }
            });

            // prompt helper: show a small two-button modal and resolve 'left' or 'right'
            function askPayerChoice(leftName, rightName, price, itemName){
                return new Promise((resolve)=>{
                    const overlay = document.createElement('div');
                    overlay.className = 'tcg-modal-overlay';
                    overlay.innerHTML = `
                      <div class="tcg-modal">
                        <p>Charge ${price} pts for "${itemName}" to:</p>
                        <div class="tcg-modal-actions">
                          <button class="left">${leftName}</button>
                          <button class="right">${rightName}</button>
                        </div>
                      </div>`;
                    document.body.appendChild(overlay);
                    const leftBtn = overlay.querySelector('button.left');
                    const rightBtn = overlay.querySelector('button.right');
                    function cleanup(choice){
                        leftBtn.removeEventListener('click', onLeft);
                        rightBtn.removeEventListener('click', onRight);
                        try{ document.body.removeChild(overlay); }catch(e){}
                        resolve(choice);
                    }
                    function onLeft(){ cleanup('left'); }
                    function onRight(){ cleanup('right'); }
                    leftBtn.addEventListener('click', onLeft);
                    rightBtn.addEventListener('click', onRight);
                });
            }

                        // confirm helper: show a purchase confirmation modal (Confirm / Cancel)
                        function askConfirmPurchase(itemName, price){
                                return new Promise((resolve)=>{
                                        const overlay = document.createElement('div');
                                        overlay.className = 'tcg-modal-overlay';
                                        overlay.innerHTML = `
                                            <div class="tcg-modal">
                                                <p>Confirm purchase of "${itemName}" for ${price} pts?</p>
                                                <div class="tcg-modal-actions">
                                                    <button class="left">Cancel</button>
                                                    <button class="right">Confirm</button>
                                                </div>
                                            </div>`;
                                        document.body.appendChild(overlay);
                                        const cancelBtn = overlay.querySelector('button.left');
                                        const confirmBtn = overlay.querySelector('button.right');
                                        function cleanup(choice){
                                                cancelBtn.removeEventListener('click', onCancel);
                                                confirmBtn.removeEventListener('click', onConfirm);
                                                try{ document.body.removeChild(overlay); }catch(e){}
                                                resolve(choice);
                                        }
                                        function onCancel(){ cleanup(false); }
                                        function onConfirm(){ cleanup(true); }
                                        cancelBtn.addEventListener('click', onCancel);
                                        confirmBtn.addEventListener('click', onConfirm);
                                });
                        }

            // purchase handler (uses askPayerChoice)
            async function purchaseItem(id){
                const items = loadItems();
                const idx = items.findIndex(i => i.id === id);
                if(idx === -1) return;
                const item = items[idx];

                const ok = await askConfirmPurchase(item.name, item.price);
                if(!ok) return;

                // determine payer column
                // read saved header names if available
                let headers = { left: 'Left', right: 'Right' };
                try{
                  const raw = localStorage.getItem('tcg_column_headers_v1');
                  if(raw) {
                    const parsed = JSON.parse(raw);
                    headers.left = parsed.left || headers.left;
                    headers.right = parsed.right || headers.right;
                  }
                }catch(e){}

                // Ask user which column should pay using a clearer two-button modal
                let payerChoice;
                try{
                  payerChoice = await askPayerChoice(headers.left, headers.right, item.price, item.name);
                }catch(e){ payerChoice = null; }
                if(!payerChoice) return; // user dismissed

                const payer = payerChoice === 'left' ? 'left' : 'right';
                const payerName = payer === 'left' ? headers.left : headers.right;

                // load point banks
                let points = { left: 0, right: 0 };
                try{
                  const raw = localStorage.getItem('tcg_points_v1');
                  if(raw) points = JSON.parse(raw);
                }catch(e){}

                const current = Number(points[payer] || 0);
                if(current < item.price){
                    alert(`${payerName} does not have enough points (${current} pts) to purchase this item (${item.price} pts).`);
                    return;
                }

                // deduct and save
                points[payer] = current - item.price;
                try{ localStorage.setItem('tcg_points_v1', JSON.stringify(points)); }catch(e){}
                // update the on-page point displays immediately
                try{ renderPoints(); }catch(e){}

                if(item.oneTime){
                    // remove one-time items on purchase
                    items.splice(idx, 1);
                    saveItems(items);
                    render();
                    msgEl.textContent = `Purchased — ${item.name} removed. Charged ${payerName}.`;
                } else {
                    msgEl.textContent = `Purchased. Charged ${payerName}.`;
                }
                setTimeout(()=> msgEl.textContent = '', 2000);
            }

            function deleteItem(id){
                const items = loadItems();
                const idx = items.findIndex(i => i.id === id);
                if(idx === -1) return;
                const item = items[idx];
                // delete immediately without confirmation
                items.splice(idx, 1);
                saveItems(items);
                render();
                msgEl.textContent = 'Item deleted.';
                setTimeout(()=> msgEl.textContent = '', 2000);
            }

            // points display functions
            function loadPoints(){
                try{
                    const raw = localStorage.getItem('tcg_points_v1');
                    return raw ? JSON.parse(raw) : { left: 0, right: 0 };
                }catch(e){
                    return { left: 0, right: 0 };
                }
            }

            function loadHeaders(){
                try{
                    const raw = localStorage.getItem('tcg_column_headers_v1');
                    return raw ? JSON.parse(raw) : { left: 'Left Column', right: 'Right Column' };
                }catch(e){
                    return { left: 'Left Column', right: 'Right Column' };
                }
            }

            function renderPoints(){
                const points = loadPoints();
                const headers = loadHeaders();
                
                // update point values
                document.getElementById('shop-left-points').textContent = String(points.left || 0);
                document.getElementById('shop-right-points').textContent = String(points.right || 0);
                
                // update headers
                document.getElementById('left-header').textContent = headers.left;
                document.getElementById('right-header').textContent = headers.right;
            }

            // set year and initial render
            document.getElementById('year2').textContent = new Date().getFullYear();
            render();
            renderPoints(); // render initial points

            // re-render points when storage changes (in case points are updated in another tab)
            window.addEventListener('storage', (e) => {
                if(e.key === 'tcg_points_v1' || e.key === 'tcg_column_headers_v1'){
                    renderPoints();
                }
            });

            // Add Items form toggle functionality
            const toggleBtn = document.getElementById('toggle-add-form');
            if(toggleBtn){
                toggleBtn.addEventListener('click', () => {
                    const form = document.getElementById('add-item-form');
                    const isHidden = form.classList.contains('hidden');
                    
                    // toggle form visibility
                    form.classList.toggle('hidden');
                    
                    // update button state
                    toggleBtn.setAttribute('aria-expanded', String(!isHidden));
                    
                    // if showing form, focus first input
                    if(isHidden){
                        nameInput.focus();
                    }
                });

                // close form on successful add
                const originalSubmitHandler = form.onsubmit;
                form.addEventListener('submit', (e) => {
                    if(e.defaultPrevented) return; // if validation failed
                    form.classList.add('hidden');
                    toggleBtn.setAttribute('aria-expanded', 'false');
                });
            }
        })();
    </script>
</body>
</html>
